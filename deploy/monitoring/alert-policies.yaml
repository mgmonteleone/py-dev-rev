# Alert Policies for DevRev MCP Server Audit Monitoring
#
# PREREQUISITE: Create log-based metrics first
# These alert policies require log-based metrics to be created before applying.
#
# Step 1: Create log-based metrics
# Run these commands to create the required metrics:
#
#   # Metric 1: Authentication failures
#   gcloud logging metrics create mcp_auth_failures \
#     --description="Count of MCP authentication failures" \
#     --log-filter='resource.type="cloud_run_revision"
#       jsonPayload.event_type="audit"
#       jsonPayload.action="auth_failure"'
#
#   # Metric 2: Destructive operations (deletes)
#   gcloud logging metrics create mcp_destructive_ops \
#     --description="Count of MCP destructive operations" \
#     --log-filter='resource.type="cloud_run_revision"
#       jsonPayload.event_type="audit"
#       jsonPayload.action="tool_invocation"
#       jsonPayload.tool.category="delete"'
#
#   # Metric 3: Tool invocation failures
#   gcloud logging metrics create mcp_tool_failures \
#     --description="Count of MCP tool invocation failures" \
#     --log-filter='resource.type="cloud_run_revision"
#       jsonPayload.event_type="audit"
#       jsonPayload.action="tool_invocation"
#       jsonPayload.outcome="failure"'
#
# Step 2: Create notification channels
#   gcloud alpha monitoring channels create \
#     --display-name="DevRev Alerts" \
#     --type=email \
#     --channel-labels=email_address=alerts@example.com
#
# Step 3: Get channel ID
#   gcloud alpha monitoring channels list
#
# Step 4: Replace NOTIFICATION_CHANNEL_ID and PROJECT_ID below
#
# Step 5: Apply alert policies
#   gcloud alpha monitoring policies create --policy-from-file=deploy/monitoring/alert-policies.yaml

---
# Policy 1: High Authentication Failure Rate
# Triggers when more than 10 failed authentication attempts occur within 5 minutes
displayName: "DevRev MCP - High Auth Failure Rate"
documentation:
  content: |
    ## High Authentication Failure Rate Detected

    More than 10 failed authentication attempts detected in a 5-minute window.
    This may indicate:
    - Brute force attack attempt
    - Misconfigured client credentials
    - Expired or invalid tokens

    **Action Required:**
    1. Review audit logs for the affected user/IP
    2. Check if credentials need rotation
    3. Consider temporary IP blocking if attack is detected

    **Query logs:**
    ```
    resource.type="cloud_run_revision"
    jsonPayload.event_type="audit"
    jsonPayload.action="auth_failure"
    ```
  mimeType: "text/markdown"
conditions:
  - displayName: "Auth failure count > 10 in 5 minutes"
    conditionThreshold:
      filter: 'metric.type="logging.googleapis.com/user/mcp_auth_failures" resource.type="cloud_run_revision"'
      aggregations:
        - alignmentPeriod: "300s"
          perSeriesAligner: "ALIGN_RATE"
          crossSeriesReducer: "REDUCE_SUM"
      comparison: "COMPARISON_GT"
      thresholdValue: 10
      duration: "0s"
notificationChannels:
  - "projects/PROJECT_ID/notificationChannels/NOTIFICATION_CHANNEL_ID"
alertStrategy:
  autoClose: "1800s"  # Auto-close after 30 minutes if resolved

---
# Policy 2: High Destructive Operation Rate
# Triggers when more than 20 delete operations occur within 10 minutes
displayName: "DevRev MCP - High Destructive Operation Rate"
documentation:
  content: |
    ## High Rate of Destructive Operations

    More than 20 delete operations detected in a 10-minute window.
    This may indicate:
    - Accidental bulk deletion
    - Malicious activity
    - Runaway automation script

    **Action Required:**
    1. Immediately review audit logs for affected resources
    2. Identify the user/service account performing deletions
    3. Verify if deletions are intentional
    4. Consider pausing the service if unauthorized
    5. Check if backups are available for recovery

    **Query logs:**
    ```
    resource.type="cloud_run_revision"
    jsonPayload.event_type="audit"
    jsonPayload.action="tool_invocation"
    jsonPayload.tool.category="delete"
    ```
  mimeType: "text/markdown"
conditions:
  - displayName: "Delete operations > 20 in 10 minutes"
    conditionThreshold:
      filter: 'metric.type="logging.googleapis.com/user/mcp_destructive_ops" resource.type="cloud_run_revision"'
      aggregations:
        - alignmentPeriod: "600s"
          perSeriesAligner: "ALIGN_RATE"
          crossSeriesReducer: "REDUCE_SUM"
      comparison: "COMPARISON_GT"
      thresholdValue: 20
      duration: "0s"
notificationChannels:
  - "projects/PROJECT_ID/notificationChannels/NOTIFICATION_CHANNEL_ID"
alertStrategy:
  autoClose: "3600s"  # Auto-close after 1 hour if resolved
  notificationRateLimit:
    period: "300s"  # Limit notifications to once per 5 minutes

---
# Policy 3: Elevated Tool Failure Rate
# Triggers when more than 10 tool failures occur within 5 minutes
# Note: For true percentage-based alerting, use MQL (Monitoring Query Language) in the console
displayName: "DevRev MCP - Elevated Error Rate"
documentation:
  content: |
    ## Elevated Tool Failure Rate

    More than 10 tool failures detected in a 5-minute period.
    This may indicate:
    - API connectivity issues with DevRev
    - Service degradation
    - Invalid credentials or permissions
    - Bug in tool implementation

    **Action Required:**
    1. Check DevRev API status
    2. Review error messages in audit logs
    3. Verify service account permissions
    4. Check for recent code deployments
    5. Monitor for continued failures

    **Query logs:**
    ```
    resource.type="cloud_run_revision"
    jsonPayload.event_type="audit"
    jsonPayload.outcome="failure"
    ```
  mimeType: "text/markdown"
conditions:
  - displayName: "Tool failures > 10 in 5 minutes"
    conditionThreshold:
      filter: 'metric.type="logging.googleapis.com/user/mcp_tool_failures" resource.type="cloud_run_revision"'
      aggregations:
        - alignmentPeriod: "300s"
          perSeriesAligner: "ALIGN_RATE"
          crossSeriesReducer: "REDUCE_SUM"
      comparison: "COMPARISON_GT"
      thresholdValue: 10
      duration: "0s"
notificationChannels:
  - "projects/PROJECT_ID/notificationChannels/NOTIFICATION_CHANNEL_ID"
alertStrategy:
  autoClose: "1800s"  # Auto-close after 30 minutes if resolved

